---
title: Multi-Tenancy & Tenant Management
status: Draft
epic: 10
story: 1
---

# User Story: As a System Administrator, I want to manage tenants in the system, so that I can onboard new schools and manage their lifecycle, ensuring absolute data separation.

## Acceptance Criteria:
- The system shall be built on a multi-tenant architecture where the data for each school (tenant) is strictly isolated.
- The system shall provide an interface for a System Administrator to create, manage, suspend, and reactivate tenant accounts.
- When a new tenant is created, the system shall provision their account and create an initial 'Tenant Admin' user for that school. **This admin, and every subsequent user, must be directly associated with the tenant's `tenant_id` in the `Users` table.**
- **Every table containing tenant-specific data, including `Users`, `Students`, `Grades`, `Finance`, etc., MUST have a non-nullable `tenant_id` column.**
- **Every single database query (read, write, update, delete) executed by the application must be filtered by the `tenant_id` of the currently authenticated user. There are no exceptions.**
- A query for one tenant must never, under any circumstances, return data from another tenant.
- The tenant onboarding process should be automated as much as possible.

## Examples:
- **New School Onboarding:** A System Admin creates a new tenant, 'Evergreen Academy'. The system generates a unique `tenant_id` (e.g., `e3b0c442...`). It then inserts a new record into the `Users` table for their admin, and this user record explicitly includes the `tenant_id: 'e3b0c442...'`.
- **Data Isolation Enforcement:** When the admin for 'Evergreen Academy' logs in, a `tenant_id` is stored in their session. Every subsequent API call they make uses a data access layer that **automatically and mandatorily** adds `WHERE tenant_id = 'e3b0c442...'` to all SQL queries.

## Potential Obstacles:
- **Architectural Discipline:** The chosen multi-tenancy model (shared database with a `tenant_id` column) requires **extreme, unwavering discipline** in the data access layer. One mistake can cause a major data breach. The technical design must make it impossible for a developer to forget the tenant filter.
- **Preventing Data Leakage:** A single missing `WHERE tenant_id = ?` clause in a complex query can cause a catastrophic data breach. This requires building a robust and non-bypassable data access layer (e.g., a global query scope or middleware) that automatically applies tenant filtering to every database query. This cannot be an optional or manual step for developers.
- **Cross-Tenant Operations:** Performing operations across all tenants (e.g., for system-wide reporting or data migrations) becomes more complex and needs to be done carefully to avoid performance degradation and to respect data isolation boundaries.

## Dev Notes:

### Previous Story Insights:
- This is a foundational, cross-cutting concern that underpins every other feature in the application. It is not an epic that can be built in isolation but must be integrated into the development of all other features from day one.

### Data Models:
- **Tenants Table:** The central table to store information about each school/tenant, including their unique ID, name, status (active, suspended), and subscription/plan details.
- **`tenant_id` Column:** This column must be added to **every single table** in the database that contains tenant-specific data and be non-nullable. This includes the `Users` table.

## Tasks / Subtasks:
- [ ] Task 1 (Architecture): Formally decide on and document the multi-tenancy architecture strategy (shared DB with mandatory `tenant_id` filtering).
- [ ] Task 2 (Dev): Implement the `Tenants` table and the admin interface for managing tenants.
- [ ] Task 3 (Dev): Create an automated tenant provisioning process, ensuring the first user is correctly associated with the tenant.
- [ ] Task 4 (Dev): **(Critical)** Implement a middleware or extend the ORM's base model/repository to automatically and mandatorily enforce `tenant_id` filtering on all database queries.
- [ ] Task 5 (Testing): Create a dedicated suite of integration tests specifically designed to try and break tenant data isolation.
- [ ] Task 6 (Dev): Implement the logic and UI for suspending and reactivating a tenant's account.
